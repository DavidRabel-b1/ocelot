#!/bin/bash

get_box() {
    outline=$1
    fill=$2
    content=$3

    box="^pa(;10)^fg($outline)^r(75x8)^fg($fill)^ib(1)^pa(4;14)^r(67x4)\n"
    box+="^fg($outline)^r(75x16)^fg($fill)^ib(1)^pa(4)^r(67x16)^pa(8;2)^fg(#ffffff)$content\n"
    box+="^pa(;0)^fg($outline)^r(75x8)^fg($fill)^ib(1)^pa(4;0)^r(67x4)"

    echo "$box"
}

guess_display_height() {
    current_resolution="$( xrandr -q --verbose | grep "*current" )"
    _tmp1CR=${current_resolution#*x}

    # debug
    # echo "$_tmp1CR"

    current_height=${_tmp1CR%% *}
    echo -n "$current_height"
}

display_height=$( guess_display_height )
panel_line_count=$(( display_height/16))

# debug
echo "panel_line_count=$panel_line_count"

ofifo=/tmp/ocollector.fifo
[[ -p $ofifo ]] || mkfifo -m 600 "$ofifo"

tail -f $ofifo | \
while read -r reply ; do
    # parse input from fifo
    replyType=${reply%%:=*} # use first part of reply seperated by :=
    replyContent=${reply#*:=} # use last part of reply seperated by :=
    _tmp1=${replyContent%%;;*} # first
    if [[ -z "$_tmp1" ]] ; then
        _isBox=false
    else
        _box=${replyContent#*;;} # last
        replyContent="$_tmp1"
        boxOutline=${_box%%--*} # first
        boxFill=${_box#*--} # last
        _isBox=true
    fi

    if [[ "$replyType" == "otime" ]] ; then
        otime="$replyContent"
    elif [[ "$replyType" == "odesktop" ]] ; then
        odesktop="$( get_box "$boxOutline" "$boxFill" "$replyContent" )"
    elif [[ "$replyType" == "odesktops" ]] ; then
        odesktops="$replyContent"
    elif [[ "$replyType" == "otest" ]] ; then
        otest="$( get_box "$boxOutline" "$boxFill" "$replyContent" )"
        # otest_boxOutline="$boxOutline"
        # otest_boxFill="$boxFill"
    elif [[ "$replyType" == "obattery" ]] ; then
        obattery="$( get_box "$boxOutline" "$boxFill" "$replyContent" )"
    fi

    # "otime" has to be the first replyType, because it clears all lines of
    # the child-window
    echo -e "^tw()$otime"
    echo -e "$odesktop"
    echo -e "$odesktops"
    echo -e "$obattery"

    # test
    echo -e "$otest"
    echo -e "$otest_boxOutline\n$otest_boxFill"

done | ocelot-dzen -p -l "$panel_line_count" -h 16 -ta l -w 75 -fn "monospace:bold:size=9" -e 'onstart=uncollapse' -bg "#292929"
# dzen2 -p -x 100 -y 700 -w 500
# -l 48
# -bg "#2c2c2c"
# -l 40 # xephyr development setup
